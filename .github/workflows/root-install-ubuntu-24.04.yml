name: Cache install of Root sources
on:
  workflow_call:
    inputs:
      version:
        type: string
        required: false

env:
  ROOT_VERSION: ${{ inputs.version || '6.26.14' }}

jobs:
  call-root-sources:
    uses: ./.github/workflows/root-src-install-ubuntu-24.04.yml
  build:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Install root build dependencies
      run: |
          sudo apt install -y libgsl-dev gfortran libpcre3-dev \
          libglu1-mesa-dev libglew-dev libftgl-dev \
          libfftw3-dev libcfitsio-dev libgraphviz-dev \
          libavahi-compat-libdnssd-dev libldap2-dev \
          python3-dev python3-numpy libxml2-dev libkrb5-dev \
          libgsl-dev qtwebengine5-dev nlohmann-json3-dev libmysqlclient-dev \
          libgl2ps-dev \
          liblzma-dev libxxhash-dev liblz4-dev libzstd-dev libxpm-dev libxft-dev libtbb-dev

    - name: Restore Root sources
      uses: actions/cache/restore@v4
      with:
        path: root/${{env.ROOT_VERSION}}/src
        key: ${{ runner.os }}-root-src-${{ env.ROOT_VERSION }}

    - name: Cache Root install
      uses: actions/cache@v4
      with:
        path: root/${{env.ROOT_VERSION}}/${{ runner.os }}
        key: ${{ runner.os }}-root-${{ env.ROOT_VERSION }}

    - name: Create install directory
      run: mkdir -p root/${{env.ROOT_VERSION}}/${{ runner.os }}
    - name: Create build directory
      run: mkdir -p root/${{env.ROOT_VERSION}}/${{ runner.os }}-build
    - name: Configure build
      working-directory: root/${{env.ROOT_VERSION}}/${{ runner.os }}-build
      run: cmake ../src/root-${{env.ROOT_VERSION}} -DCMAKE_INSTALL_PREFIX=../${{ runner.os }} -DVERBOSE=ON -DCMAKE_VERBOSE_MAKEFILE=ON
    - name: Build root
      working-directory: root/${{env.ROOT_VERSION}}/${{ runner.os }}-build
      run: make
    - name: Install root
      working-directory: root/${{env.ROOT_VERSION}}/${{ runner.os }}-build
      run: make install
      